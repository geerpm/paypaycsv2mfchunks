<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Chunk and Zip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            padding: 2rem;
        }
        #status {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            min-height: 100px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">CSV Chunk and Zip Tool</h1>
        <p>CSVファイルを選択し、「処理実行」ボタンを押してください。ファイルは100行ごとに分割され、ZIPファイルとしてダウンロードされます。</p>
        
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
                <a href="https://support.me.moneyforward.com/hc/ja/articles/47213969326361-PayPay%E3%81%AE%E5%8F%96%E5%BC%95%E5%B1%A5%E6%AD%B4CSV%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E6%A9%9F%E8%83%BD%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6" class="alert-link" target="_blank" rel="noopener noreferrer">PayPayの取引履歴CSVファイルの読み込み機能について</a>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="csvFile" class="form-label">CSVファイルを選択</label>
            <input class="form-control" type="file" id="csvFile" accept=".csv">
        </div>
        
        <button id="processBtn" class="btn btn-primary">処理実行</button>
        
        <div id="status">
            処理状況が表示されます...
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        const csvFileInput = document.getElementById('csvFile');
        const processBtn = document.getElementById('processBtn');
        const statusDiv = document.getElementById('status');

        processBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) {
                logStatus("エラー: ファイルが選択されていません。");
                return;
            }

            logStatus(`処理を開始します: ${file.name}`);

            Papa.parse(file, {
                header: false, // ヘッダーをデータの一部として扱う
                skipEmptyLines: true,
                complete: (results) => {
                    processData(results.data, file.name);
                },
                error: (error) => {
                    logStatus(`CSVの解析中にエラーが発生しました:\n${error.message}`);
                }
            });
        });

        function processData(data, originalFileName) {
            if (data.length <= 1) {
                logStatus("エラー: CSVにヘッダー行以外のデータがありません。");
                return;
            }

            const header = data[0];
            const rows = data.slice(1);
            const chunkSize = 100;
            const zip = new JSZip();
            let chunkCount = 0;

            logStatus(`合計 ${rows.length} 行のデータを検出しました。`);
            logStatus(`${chunkSize} 行ごとに分割を開始します...`);

            for (let i = 0; i < rows.length; i += chunkSize) {
                chunkCount++;
                const chunk = rows.slice(i, i + chunkSize);
                
                // ヘッダーとデータチャンクを結合
                const chunkData = [header, ...chunk];
                
                // CSV文字列に変換
                const csvString = Papa.unparse(chunkData);
                
                // 4桁ゼロ埋めのファイル名を作成
                const fileName = `chunk${String(chunkCount).padStart(4, '0')}.csv`;
                
                // ZIPファイルに追加
                zip.file(fileName, csvString);
                logStatus(`  - ${fileName} を作成しました。（${chunk.length}行）`);
            }

            logStatus("ZIPファイルを生成しています...");

            zip.generateAsync({ type: "blob" })
                .then((content) => {
                    const zipFileName = `${originalFileName.replace(/\.csv$/i, '')}_chunks.zip`;
                    saveAs(content, zipFileName);
                    logStatus(`完了: ${zipFileName} のダウンロードが開始されました。`);
                })
                .catch(err => {
                    logStatus(`ZIPファイルの生成中にエラーが発生しました:\n${err.message}`);
                });
        }

        function logStatus(message) {
            console.log(message);
            statusDiv.textContent += message + '\n';
        }

    </script>
</body>
</html>
